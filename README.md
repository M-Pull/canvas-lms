Canvas LMS
======

Canvas is a modern, open-source [LMS](https://en.wikipedia.org/wiki/Learning_management_system)
developed and maintained by [Instructure Inc.](https://www.instructure.com/) It is released under the
AGPLv3 license for use by anyone interested in learning more about or using
learning management systems.

[Please see our main wiki page for more information](http://github.com/instructure/canvas-lms/wiki)

Installation
=======

Detailed instructions for installation and configuration of Canvas are provided
on our wiki.

 * [Quick Start](http://github.com/instructure/canvas-lms/wiki/Quick-Start)
 * [Production Start](http://github.com/instructure/canvas-lms/wiki/Production-Start)

SpeakBiz installation (production)
======

Routing
=======
Create a sub-domain in the DNS recoreds.
Create a sub-domain like:
```
ac.speakbiz.com.bo
```

Database
=======

Install an Ubuntu server using Ngnix with PostgreSQL DB v17
Database: create ```canvas_production``` or ```canvas_development```
Username: ploi
Password: Located in the server creation email.

Repository
=======
Clone ```prod``` branch

```
sysadmin@appserver:~$ sudo chown -R sysadmin /var/canvas
sysadmin@appserver:~$ sudo mkdir -p /var/canvas
sysadmin@appserver:~$ sudo chown -R sysadmin /var/canvas
sysadmin@appserver:~$ cd canvas
sysadmin@appserver:~/canvas$ ls
app     db   Gemfile  log     Rakefile  spec  tmp
config  doc  lib      public  script    test  vendor
sysadmin@appserver:~/canvas$ cp -av . /var/canvas
sysadmin@appserver:~/canvas$ cd /var/canvas
sysadmin@appserver:/var/canvas$ ls
app     db   Gemfile  log     Rakefile  spec  tmp
config  doc  lib      public  script    test  vendor
sysadmin@appserver:/var/canvas$
```

Server Dependency Installation (run from the home folder, not project folder)
=======

Install dependencies

```
$ sudo apt-get install software-properties-common
$ sudo add-apt-repository ppa:instructure/ruby
$ sudo apt-get update
```

Install Ruby 3.4

```
$ sudo apt-get install ruby3.4 ruby3.4-dev zlib1g-dev libxml2-dev \
                       libsqlite3-dev postgresql libpq-dev \
                       libxmlsec1-dev libyaml-dev libidn11-dev curl make g++
```

App Dependency Installation (in the project folder)
=======
Ruby Gems

Use version  2.5.11; newer versions won't work.
```
sysadmin@appserver:/var/canvas$ sudo gem install bundler -v 2.5.11
sysadmin@appserver:/var/canvas$ bundle config set --local path vendor/bundle
sysadmin@appserver:/var/canvas$ bundle install
```

Run yarn
```
sysadmin@appserver:/var/canvas$ yarn install
```

Canvas config
```
sysadmin@appserver:/var/canvas$ for config in amazon_s3 database vault_contents \
  delayed_jobs domain file_store outgoing_mail security external_migration; \
  do cp config/$config.yml.example config/$config.yml; done
```

Databawe config
```
sysadmin@appserver:/var/canvas$ cp config/database.yml.example config/database.yml
sysadmin@appserver:/var/canvas$ vim config/database.yml
```

Email config
```
sysadmin@appserver:/var/canvas$ cp config/outgoing_mail.yml.example config/outgoing_mail.yml
sysadmin@appserver:/var/canvas$ vim config/outgoing_mail.yml
```

URL config
```
sysadmin@appserver:/var/canvas$ cp config/domain.yml.example config/domain.yml
sysadmin@appserver:/var/canvas$ vim config/domain.yml
```

Security config
```
 sysadmin@appserver:/var/canvas$ cp config/security.yml.example config/security.yml
 sysadmin@appserver:/var/canvas$ vim config/security.yml
```

Database population
=======

```
sysadmin@appserver:/var/canvas$ yarn gulp rev
sysadmin@appserver:/var/canvas$ RAILS_ENV=production bundle exec rake db:initial_setup
```

Dynamic settings configuration
=======

```
sysadmin@appserver:/var/canvas$ cp config/dynamic_settings.yml.example config/dynamic_settings.yml
sysadmin@appserver:/var/canvas$ nano config/dynamic_settings.yml
```

Generate Assets
=======
```
sysadmin@appserver:/var/canvas$ mkdir -p log tmp/pids public/assets app/stylesheets/brandable_css_brands
sysadmin@appserver:/var/canvas$ touch app/stylesheets/_brandable_variables_defaults_autogenerated.scss
sysadmin@appserver:/var/canvas$ touch Gemfile.lock
sysadmin@appserver:/var/canvas$ touch log/production.log
sysadmin@appserver:/var/canvas$ sudo chown -R ploi config/environment.rb log tmp public/assets \
                              app/stylesheets/_brandable_variables_defaults_autogenerated.scss \
                              app/stylesheets/brandable_css_brands Gemfile.lock config.ru
```

Then will need to run:

```
sysadmin@appserver:/var/canvas$ RAILS_ENV=production bundle exec rake canvas:compile_assets
sysadmin@appserver:/var/canvas$ chown -R ploi public/dist/brandable_css
```

Subsequent Updates (NOT NEEDED FOR INITIAL DEPLOY)

If you are updating code, and you run canvas:compile_assets in a place that does not have a database connection, then you'll also want to run the following once code is in place and an active DB connection exists, in order to full update existing themes:
```
sysadmin@appserver:/var/canvas$ sudo RAILS_ENV=production bundle exec rake brand_configs:generate_and_upload_all
```

Ngnix config
=======

Create deamons in the server:

Server -> Deamons -> New deamon -> Add deamon
Change the project folder as needed:

```
bash -lc 'cd /home/ploi/ac.speakbiz.com.bo && exec bundle exec puma -C config/puma.rb -e production'
```
and 
```
bash -lc 'cd /home/ploi/ac.speakbiz.com.bo && RAILS_ENV=production bin/delayed_job start'
```
For both deamons use:
```
Process 1
Directory (empty)
Environment file (empty)
System user: ploi
```


Configure PUMA, simple, via TCP

```
cat > config/puma.rb <<'RB'
# config/puma.rb (simple por TCP)
threads_count = ENV.fetch("RAILS_MAX_THREADS", 5).to_i
threads threads_count, threads_count
workers ENV.fetch("WEB_CONCURRENCY", 2).to_i
preload_app!

bind "tcp://127.0.0.1:3000"        # <<< evita lÃ­os de sockets
pidfile "tmp/pids/puma.pid"
stdout_redirect "log/puma.stdout.log", "log/puma.stderr.log", true

environment "production"
RB
```

Ngix config:
Change from:
```
    location / {
        # try_files $uri $uri/ /index.php?$query_string;
    }
```
To:
```
location ~ ^/(assets|packs|uploads)/ { expires max; add_header Cache-Control "public, immutable"; try_files $uri @app; }    

    location / {
        # try_files $uri $uri/ /index.php?$query_string;
        try_files $uri @app;
    }

    location @app {
        proxy_pass http://127.0.0.1:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300;
        proxy_send_timeout 300;
    }
```

And remove/comment out:
```
    # location ~ \.php$ {
    #     try_files $uri /index.php =404;
    #     fastcgi_split_path_info ^(.+\.php)(/.+)$;
    #     fastcgi_pass unix:/run/php/php8.4-fpm.sock;
    #     fastcgi_buffers 32 32k;
    #     fastcgi_index index.php;
    #     fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
    #     fastcgi_param DOCUMENT_ROOT $realpath_root;
    #     include fastcgi_params;
    # }
```


Restart Ngnix.




